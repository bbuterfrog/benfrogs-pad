var map;var mapIsTab=false;var mapOptions;var rectangle;var boundsChanged;var polyClicked;var geocoder;var markers=[];var markerZoom=false;var infowindow;var geolocationcontrolDiv;var geolocationcontrol;$(document).ready(function(){getHeader();getHTML("footer","footer");getHTML("innerHowItWorks","mapsHowItWorks");getHTML("addressSearch","addressSearch")});!function($){$(function(){window.prettyPrint&&prettyPrint()})}(window.jQuery);function initalize(){mapOptions={center:new google.maps.LatLng(0,0),zoom:2,mapTypeControl:false};if($("#bigMap").is(":visible")){$.ajax({url:"../main/php/mapsServer.php?contentType=html&content=bigMap",contentType:"html"}).done(function(content){$("#bigMap").html(content);makeMap()})}else{$.ajax({url:"../main/php/mapsServer.php?contentType=html&content=tabMap",contentType:"html"}).done(function(content){$("#mapTabs").html(content);makeMap();mapIsTab=true;$("#mapTab a").click(function(e){e.preventDefault();$(this).tab("show")});$("#customers a").click(function(e){e.preventDefault();$(this).tab("show")})})}}function makeMap(){geocoder=new google.maps.Geocoder();map=new google.maps.Map(document.getElementById("map"),mapOptions);google.maps.event.addDomListener(window,"resize",function(){var center=map.getCenter();google.maps.event.trigger(map,"resize");map.setCenter(center)});boundsChanged=google.maps.event.addListener(map,"bounds_changed",function(){var mapBounds=map.getBounds();rectangle=new google.maps.Rectangle({bounds:map.getBounds(),strokeOpacity:0,fillOpacity:0,map:map});polyClicked=google.maps.event.addListener(rectangle,"click",function(args){countryName=reverseGeocode(args.latLng,"country")})});var input=document.getElementById("pac-input");var searchBox=new google.maps.places.SearchBox(input);map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);map.addListener("bounds_changed",function(){searchBox.setBounds(map.getBounds())});searchBox.addListener("places_changed",function(){var bounds=new google.maps.LatLngBounds();var places=searchBox.getPlaces();if(places.length==0){return}places.forEach(function(place){if(place.geometry.viewport){bounds.union(place.geometry.viewport)}else{bounds.extend(place.geometry.location)}});map.fitBounds(bounds);rectangle=null;google.maps.event.removeListener(boundsChanged);getMarkers(bounds)});geolocationcontrolDiv=document.createElement("div");geolocationcontrol=new geolocationControl(geolocationcontrolDiv,map);geolocationcontrolDiv.index=1;map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(geolocationcontrolDiv)}function reverseGeocode(latLng,type){geocoder.geocode({location:latLng},function(results,status){if(status===google.maps.GeocoderStatus.OK){$.each(results[0].address_components,function(key,value){if(value.types[0]==type){google.maps.event.removeListener(polyClicked);zoomToViewport(value.long_name)}})}else{console.log("Could not find "+type+" due to: "+status)}})}function zoomToViewport(area){geocoder.geocode({address:area},function(results,status){if(status===google.maps.GeocoderStatus.OK){map.setCenter(results[0].geometry.location);map.fitBounds(results[0].geometry.viewport);rectangle=null;google.maps.event.removeListener(boundsChanged);getMarkers(results[0].geometry.viewport)}else{console.log("Could not find viewport due to: "+status)}})}function getMarkers(bounds){makeMapTable(bounds);markers=[];var dataObject={NELat:bounds.getNorthEast().lat(),NELng:bounds.getNorthEast().lng(),SWLat:bounds.getSouthWest().lat(),SWLng:bounds.getSouthWest().lng()};$.ajax({url:"../main/php/mapsServer.php?content=getPoints&contentType=json",data:dataObject,type:"POST",dataType:"json"}).done(function(content){for(var i=0;i<content.length;i++){var addressID=content[i].address_id;var lat=content[i].lat;var lng=content[i].lng;var latLng=new google.maps.LatLng(lat,lng);var marker=new google.maps.Marker({position:latLng,map:map});google.maps.event.addListener(marker,"click",(function(marker,addressID){return function(){markerZoom=true;map.setCenter(marker.getPosition());map.setZoom(8);markerZoom=false;openInfoBubble(marker,addressID)}})(marker,addressID));markers[addressID]=marker}google.maps.event.addListener(map,"dragend",function(){if(markerZoom==false){var bounds=map.getBounds();getMarkers(bounds)}});google.maps.event.addListener(map,"zoom_changed",function(){if(markerZoom==false){var bounds=map.getBounds();getMarkers(bounds)}})})}function openInfoBubble(marker,addressID){var dataObject={addressID:addressID};$.ajax({url:"../main/php/mapsServer.php?contentType=json&content=customerBubble",data:dataObject,type:"POST",dataType:"json"}).done(function(windowContent){$.ajax({url:"../main/php/mapsServer.php?contentType=html&content=infoBubble",contentType:"html"}).done(function(templateHTML){var template=Handlebars.compile(templateHTML);var infoBubbleHTML=template(windowContent[0]);if(infowindow){infowindow.close()}infowindow=new google.maps.InfoWindow();infowindow.setContent(infoBubbleHTML);infowindow.open(map,marker)})})}function makeMapTable(bounds){var dataObject={NELat:bounds.getNorthEast().lat(),NELng:bounds.getNorthEast().lng(),SWLat:bounds.getSouthWest().lat(),SWLng:bounds.getSouthWest().lng()};$.ajax({url:"../main/php/mapsServer.php?contentType=json&content=customerTable",data:dataObject,type:"POST",dataType:"json"}).done(function(customerTable){$.ajax({url:"../main/php/mapsServer.php?contentType=html&content=mapsTable",contentType:"html"}).done(function(templateHTML){var template=Handlebars.compile(templateHTML);var wrapper={objects:customerTable};$("#mapsTable").html(template(wrapper));$(document).on("click",".mapMarker",function(){if(mapIsTab==true){$('.nav-tabs a[href="#mapTab"]').tab("show");$("html,body").animate({scrollTop:$("#beforeTabs").offset().top-10})}else{$("html,body").animate({scrollTop:$("#beforeTabs").offset().top-10})}google.maps.event.trigger(markers[this.id],"click")})})})}function geolocationControl(controlDiv,map){var controlUI=document.createElement("div");controlUI.style.backgroundColor="#fff";controlUI.style.border="2px solid #fff";controlUI.style.borderRadius="3px";controlUI.style.boxShadow="0 2px 6px rgba(0,0,0,.3)";controlUI.style.cursor="pointer";controlUI.style.marginBottom="22px";controlUI.style.textAlign="center";controlUI.title="Find Me";controlDiv.appendChild(controlUI);var controlText=document.createElement("div");controlText.style.color="rgb(25,25,25)";controlText.style.lineHeight="38px";controlText.style.paddingLeft="5px";controlText.style.paddingRight="5px";controlText.innerHTML='<i class="fa fa-crosshairs"></i>';controlUI.appendChild(controlText);controlUI.addEventListener("click",function(){getViewportByLocation()})}function getViewportByLocation(){$.ajax({url:"../main/php/mapsServer.php?contentType=html&content=locationModal",contentType:"html"}).done(function(templateHTML){$("#beforeTabs").html(templateHTML);locationModalTitle.html('<h3 class="modal-title">Finding your Location...');locationModalBody.html('<center><img src="../main/img/loading.gif"></img></center>');if(!navigator.geolocation){locationModalTitle.html('<h3 class="modal-title">Error Finding Location</h3>');locationModalBody.html('<i class="fa fa-exclamation-triangle fa-3x warning h3"></i>Sorry, your browser does not support location');$("#locationModal").modal()}else{function success(position){var latitude=position.coords.latitude;var longitude=position.coords.longitude;var latLng=new google.maps.LatLng(latitude,longitude);reverseGeocode(latLng,"country")}function error(error){locationModalTitle.html('<h3 class="modal-title">Error Finding Location</h3>');locationModalBody.html('<i class="fa fa-exclamation-triangle fa-3x warning h3"></i>Error finding location');$("#locationModal").modal();console.log(error)}navigator.geolocation.getCurrentPosition(success,error)}})};